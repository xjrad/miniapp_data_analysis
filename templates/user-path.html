<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·è·¯å¾„åˆ†æ - äºšé©¬é€Šå…¨çƒå¼€åº—</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.2/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            color: white;
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin-right: 20px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .header-content h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header-content p {
            font-size: 1em;
            opacity: 0.9;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .control-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .control-section:last-child {
            margin-bottom: 0;
        }
        .control-section h3 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .control-group label {
            font-weight: 500;
            color: #555;
            min-width: 120px;
        }
        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        .control-group select:focus, .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .control-group select:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        
        /* åˆ†æé€‰é¡¹é€‰æ‹© */
        .options-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .category-tabs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .category-tab {
            padding: 12px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
        }
        .category-tab:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .category-tab.active {
            border-color: #667eea;
            background: #e3f2fd;
            color: #667eea;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .option-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .option-item.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }
        .option-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }
        .option-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .option-label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        .option-type {
            font-size: 11px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            width: fit-content;
        }
        .option-count {
            font-size: 12px;
            color: #666;
            margin-left: auto;
            font-weight: 600;
        }
        
        /* è·¯å¾„å®šä¹‰ */
        .path-definition {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .path-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            transition: all 0.3s ease;
        }
        .path-option.active {
            border-color: #667eea;
            background: #e3f2fd;
        }
        .path-option input[type="radio"] {
            margin-right: 8px;
        }
        .path-option label {
            font-weight: 600;
            color: #333;
            cursor: pointer;
        }
        .path-option select {
            width: 100%;
            margin-top: 10px;
        }
        
        /* é€‰ä¸­ç»Ÿè®¡ */
        .selection-summary {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            color: #2e7d2e;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            font-weight: 500;
        }
        
        /* æŒ‰é’® */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* å›¾è¡¨åŒºåŸŸ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .chart-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        .chart {
            width: 100%;
            height: 450px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        
        /* è·¯å¾„è¡¨æ ¼ */
        .path-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }
        .path-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .path-table th, .path-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .path-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        .path-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        /* æç¤ºä¿¡æ¯ */
        .tip-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1976d2;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            .control-group label {
                min-width: auto;
            }
            .header {
                flex-direction: column;
                text-align: center;
            }
            .back-btn {
                margin-right: 0;
                margin-bottom: 15px;
            }
            .path-definition {
                grid-template-columns: 1fr;
            }
            .options-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">â† è¿”å›</button>
            <div class="header-content">
                <h1>ğŸ›¤ï¸ ç”¨æˆ·è·¯å¾„åˆ†æ</h1>
                <p>æ·±å…¥åˆ†æç”¨æˆ·åœ¨å°ç¨‹åºä¸­çš„è¡Œä¸ºè·¯å¾„å’Œè½¬åŒ–æƒ…å†µ</p>
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <!-- åˆ†æé€‰é¡¹é€‰æ‹© -->
            <div class="control-section">
                <h3>ğŸ“ é€‰æ‹©åˆ†æé€‰é¡¹ <small>(äº‹ä»¶ã€é¡µé¢ã€æ ‡é¢˜)</small></h3>
                
                <div class="options-container">
                    <div class="category-tabs">
                        <div class="category-tab active" data-category="all" onclick="switchCategory('all')">
                            ğŸ“Š å…¨éƒ¨é€‰é¡¹
                        </div>
                        <div class="category-tab" data-category="events" onclick="switchCategory('events')">
                            âš¡ äº‹ä»¶ç±»å‹
                        </div>
                        <div class="category-tab" data-category="pages" onclick="switchCategory('pages')">
                            ğŸ“„ é¡µé¢è·¯å¾„
                        </div>
                        <div class="category-tab" data-category="urls" onclick="switchCategory('urls')">
                            ğŸ”— URLè·¯å¾„
                        </div>
                        <div class="category-tab" data-category="titles" onclick="switchCategory('titles')">
                            ğŸ·ï¸ é¡µé¢æ ‡é¢˜
                        </div>
                        <div class="category-tab" data-category="referrers" onclick="switchCategory('referrers')">
                            ğŸŒ æ¥æºæ¸ é“
                        </div>
                    </div>
                    
                    <div class="options-grid" id="optionsGrid">
                        <!-- åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
                    </div>
                </div>
                
                <div class="selection-summary" id="selectionSummary">
                    ğŸ’¡ æš‚æ— é€‰ä¸­é¡¹ï¼Œè¯·é€‰æ‹©è¦åˆ†æçš„äº‹ä»¶ã€é¡µé¢æˆ–æ ‡é¢˜
                </div>
                
                <div class="tip-box">
                    ğŸ’¡ å¯ä»¥æ··åˆé€‰æ‹©äº‹ä»¶ã€é¡µé¢è·¯å¾„ã€URLè·¯å¾„ã€é¡µé¢æ ‡é¢˜å’Œæ¥æºæ¸ é“è¿›è¡Œç»¼åˆåˆ†æã€‚æ”¯æŒæŒ‰ç±»åˆ«å¿«é€Ÿç­›é€‰é€‰é¡¹ã€‚
                </div>
            </div>
            
            <!-- è·¯å¾„å®šä¹‰ -->
            <div class="control-section">
                <h3>ğŸ¯ è·¯å¾„å®šä¹‰æ¡ä»¶ <span style="color: #e74c3c;">(äºŒé€‰ä¸€)</span></h3>
                <div class="path-definition">
                    <div class="path-option active" id="startOption">
                        <label>
                            <input type="radio" name="pathType" value="start" checked onchange="handlePathTypeChange()">
                            æŒ‰èµ·å§‹é€‰é¡¹ç­›é€‰
                        </label>
                        <select id="startOptionSelect">
                            <option value="">ä»»æ„é€‰é¡¹</option>
                        </select>
                    </div>
                    
                    <div class="path-option" id="endOption">
                        <label>
                            <input type="radio" name="pathType" value="end" onchange="handlePathTypeChange()">
                            æŒ‰ç»“æŸé€‰é¡¹ç­›é€‰
                        </label>
                        <select id="endOptionSelect" disabled>
                            <option value="">ä»»æ„é€‰é¡¹</option>
                        </select>
                    </div>
                </div>
                <div class="tip-box">
                    ğŸ’¡ é€‰æ‹©è·¯å¾„çš„èµ·å§‹æ¡ä»¶æˆ–ç»“æŸæ¡ä»¶ï¼Œä¸èƒ½åŒæ—¶è®¾ç½®ã€‚èµ·å§‹é€‰é¡¹ï¼šåˆ†æä»æŸä¸ªé€‰é¡¹å¼€å§‹çš„è·¯å¾„ï¼›ç»“æŸé€‰é¡¹ï¼šåˆ†æä»¥æŸä¸ªé€‰é¡¹ç»“æŸçš„è·¯å¾„
                </div>
            </div>
            
            <!-- å…¶ä»–ç­›é€‰æ¡ä»¶ -->
            <div class="control-section">
                <h3>âš™ï¸ é«˜çº§ç­›é€‰æ¡ä»¶</h3>
                <div class="control-group">
                    <label>è·¯å¾„é•¿åº¦:</label>
                    <select id="pathLength">
                        <option value="all">ä¸é™åˆ¶</option>
                        <option value="2-3">2-3æ­¥</option>
                        <option value="4-5">4-5æ­¥</option>
                        <option value="6-8">6-8æ­¥</option>
                        <option value="9+">9æ­¥ä»¥ä¸Š</option>
                    </select>
                    
                    <label>æœ€å°ç”¨æˆ·æ•°:</label>
                    <input type="number" id="minConversions" value="5" min="1" max="100">
                    
                    <label>æ—¶é—´èŒƒå›´:</label>
                    <select id="timeRange">
                        <option value="today">ä»Šå¤©</option>
                        <option value="yesterday">æ˜¨å¤©</option>
                        <option value="last7days">æœ€è¿‘7å¤©</option>
                        <option value="last30days">æœ€è¿‘30å¤©</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>å…³é”®è¯ç­›é€‰:</label>
                    <input type="text" id="pageFilter" placeholder="è¾“å…¥å…³é”®è¯è¿‡æ»¤è·¯å¾„ï¼ˆå¦‚ï¼šhome, productï¼‰">
                    
                    <button class="btn" id="analyzeBtn" onclick="analyzeUserPath()">ğŸ” å¼€å§‹åˆ†æ</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ é‡ç½®æ¡ä»¶</button>
                    <button class="btn btn-secondary" onclick="loadAnalysisOptions()">ğŸ“Š åˆ·æ–°é€‰é¡¹</button>
                </div>
            </div>
        </div>
        
        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-title">ğŸ”„ ç”¨æˆ·è·¯å¾„æµè½¬å›¾ <small>(æ¡‘åŸºå›¾)</small></div>
                <div class="chart" id="pathFlowChart"></div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">ğŸ“Š è·¯å¾„æ­¥éª¤åˆ†å¸ƒ <small>(é¥¼å›¾)</small></div>
                <div class="chart" id="stepDistributionChart"></div>
            </div>
            
            <div class="chart-card full-width">
                <div class="chart-title">â±ï¸ è·¯å¾„è½¬åŒ–åˆ†æ <small>(æ¼æ–—å›¾)</small></div>
                <div class="chart" id="pathConversionChart"></div>
            </div>
        </div>
        
        <!-- è¯¦ç»†è·¯å¾„è¡¨æ ¼ -->
        <div class="path-table">
            <div class="chart-title">ğŸ“‹ è¯¦ç»†è·¯å¾„åˆ†æç»“æœ</div>
            <table id="pathTable">
                <thead>
                    <tr>
                        <th>è·¯å¾„åºåˆ—</th>
                        <th>ç”¨æˆ·æ•°</th>
                        <th>å æ¯”</th>
                        <th>å¹³å‡æ—¶é•¿</th>
                        <th>è½¬åŒ–ç‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="pathTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let pathFlowChart, stepDistributionChart, pathConversionChart;
        let isLoading = false;
        let allAnalysisOptions = {
            events: [],
            pages: [],
            urls: [],
            titles: [],
            referrers: [],
            all: []
        };
        let currentCategory = 'all';

        function initCharts() {
            pathFlowChart = echarts.init(document.getElementById('pathFlowChart'));
            stepDistributionChart = echarts.init(document.getElementById('stepDistributionChart'));
            pathConversionChart = echarts.init(document.getElementById('pathConversionChart'));
            
            window.addEventListener('resize', () => {
                pathFlowChart.resize();
                stepDistributionChart.resize();
                pathConversionChart.resize();
            });
        }

        async function loadAnalysisOptions() {
            try {
                console.log('å¼€å§‹åŠ è½½åˆ†æé€‰é¡¹...');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.querySelector('.controls').classList.add('loading');
                
                const response = await fetch('/api/analysis-options');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                allAnalysisOptions = data.options || {
                    events: [],
                    pages: [],
                    titles: [],
                    all: []
                };
                
                renderOptionsGrid();
                updatePathDefinitionOptions();
                
                console.log('åˆ†æé€‰é¡¹åŠ è½½å®Œæˆ:', {
                    events: allAnalysisOptions.events.length,
                    pages: allAnalysisOptions.pages.length,
                    urls: allAnalysisOptions.urls.length,
                    titles: allAnalysisOptions.titles.length,
                    referrers: allAnalysisOptions.referrers.length,
                    total: allAnalysisOptions.all.length
                });
                
            } catch (error) {
                console.error('åŠ è½½åˆ†æé€‰é¡¹å¤±è´¥:', error);
                // ä½¿ç”¨mockæ•°æ®
                loadMockAnalysisOptions();
            } finally {
                document.querySelector('.controls').classList.remove('loading');
            }
        }

        function loadMockAnalysisOptions() {
            // æ¨¡æ‹Ÿæ•°æ®
            allAnalysisOptions = {
                events: [
                    { key: 'event_$MPLaunch', value: '$MPLaunch', display_name: 'å°ç¨‹åºå¯åŠ¨', count: 15420, type: 'event', category: 'äº‹ä»¶ç±»å‹' },
                    { key: 'event_$MPShow', value: '$MPShow', display_name: 'é¡µé¢æ˜¾ç¤º', count: 12850, type: 'event', category: 'äº‹ä»¶ç±»å‹' },
                    { key: 'event_$MPViewScreen', value: '$MPViewScreen', display_name: 'é¡µé¢æµè§ˆ', count: 11250, type: 'event', category: 'äº‹ä»¶ç±»å‹' },
                    { key: 'event_click', value: 'click', display_name: 'ç‚¹å‡»äº‹ä»¶', count: 8970, type: 'event', category: 'äº‹ä»¶ç±»å‹' },
                    { key: 'event_search', value: 'search', display_name: 'æœç´¢', count: 3420, type: 'event', category: 'äº‹ä»¶ç±»å‹' },
                    { key: 'event_$track_signup', value: '$track_signup', display_name: 'ç”¨æˆ·æ³¨å†Œ', count: 1250, type: 'event', category: 'äº‹ä»¶ç±»å‹' }
                ],
                pages: [
                    { key: 'page_index', value: 'pages/index/index', display_name: 'é¡µé¢: index', count: 8500, type: 'page', category: 'é¡µé¢è·¯å¾„' },
                    { key: 'page_product', value: 'pages/product/detail', display_name: 'é¡µé¢: product', count: 5200, type: 'page', category: 'é¡µé¢è·¯å¾„' },
                    { key: 'page_cart', value: 'pages/cart/cart', display_name: 'é¡µé¢: cart', count: 2800, type: 'page', category: 'é¡µé¢è·¯å¾„' },
                    { key: 'page_search', value: 'pages/search/search', display_name: 'é¡µé¢: search', count: 2100, type: 'page', category: 'é¡µé¢è·¯å¾„' },
                    { key: 'page_user', value: 'pages/user/profile', display_name: 'é¡µé¢: user', count: 1800, type: 'page', category: 'é¡µé¢è·¯å¾„' }
                ],
                urls: [
                    { key: 'url_index', value: '/index.html', display_name: 'URL: index', count: 6500, type: 'url', category: 'URLè·¯å¾„' },
                    { key: 'url_product', value: '/product/detail', display_name: 'URL: product', count: 4200, type: 'url', category: 'URLè·¯å¾„' },
                    { key: 'url_api', value: '/api/data', display_name: 'URL: api', count: 3100, type: 'url', category: 'URLè·¯å¾„' },
                    { key: 'url_static', value: '/static/js', display_name: 'URL: static', count: 2500, type: 'url', category: 'URLè·¯å¾„' }
                ],
                titles: [
                    { key: 'title_é¦–é¡µ', value: 'é¦–é¡µ', display_name: 'æ ‡é¢˜: é¦–é¡µ', count: 8500, type: 'title', category: 'é¡µé¢æ ‡é¢˜' },
                    { key: 'title_å•†å“è¯¦æƒ…', value: 'å•†å“è¯¦æƒ…', display_name: 'æ ‡é¢˜: å•†å“è¯¦æƒ…', count: 5200, type: 'title', category: 'é¡µé¢æ ‡é¢˜' },
                    { key: 'title_è´­ç‰©è½¦', value: 'è´­ç‰©è½¦', display_name: 'æ ‡é¢˜: è´­ç‰©è½¦', count: 2800, type: 'title', category: 'é¡µé¢æ ‡é¢˜' },
                    { key: 'title_æœç´¢é¡µé¢', value: 'æœç´¢é¡µé¢', display_name: 'æ ‡é¢˜: æœç´¢é¡µé¢', count: 2100, type: 'title', category: 'é¡µé¢æ ‡é¢˜' }
                ],
                referrers: [
                    { key: 'referrer_baidu.com', value: 'https://www.baidu.com', display_name: 'æ¥æº: baidu.com', count: 3500, type: 'referrer', category: 'æ¥æºæ¸ é“' },
                    { key: 'referrer_google.com', value: 'https://www.google.com', display_name: 'æ¥æº: google.com', count: 2100, type: 'referrer', category: 'æ¥æºæ¸ é“' },
                    { key: 'referrer_wechat', value: 'https://mp.weixin.qq.com', display_name: 'æ¥æº: wechat', count: 1800, type: 'referrer', category: 'æ¥æºæ¸ é“' },
                    { key: 'referrer_direct', value: 'direct', display_name: 'æ¥æº: direct', count: 4200, type: 'referrer', category: 'æ¥æºæ¸ é“' }
                ],
                all: []
            };
            
            // åˆå¹¶æ‰€æœ‰é€‰é¡¹
            allAnalysisOptions.all = [
                ...allAnalysisOptions.events,
                ...allAnalysisOptions.pages,
                ...allAnalysisOptions.urls,
                ...allAnalysisOptions.titles,
                ...allAnalysisOptions.referrers
            ];
            
            renderOptionsGrid();
            updatePathDefinitionOptions();
        }

        function switchCategory(category) {
            currentCategory = category;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            renderOptionsGrid();
        }

        function renderOptionsGrid() {
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = '';
            
            const optionsToShow = currentCategory === 'all' 
                ? allAnalysisOptions.all 
                : allAnalysisOptions[currentCategory] || [];
            
            if (optionsToShow.length === 0) {
                optionsGrid.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— å¯ç”¨é€‰é¡¹<br><small>è¯·åˆ·æ–°æ•°æ®æˆ–æ£€æŸ¥æ•°æ®æº</small></div>';
                return;
            }
            
            optionsToShow.forEach(option => {
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                optionItem.setAttribute('data-key', option.key);
                
                // æ£€æŸ¥æ˜¯å¦é»˜è®¤é€‰ä¸­
                const isDefaultSelected = option.type === 'event' && 
                    ['$MPLaunch', '$MPShow', '$MPViewScreen'].includes(option.value);
                
                if (isDefaultSelected) {
                    optionItem.classList.add('selected');
                }
                
                optionItem.innerHTML = `
                    <input type="checkbox" 
                           id="option_${option.key}" 
                           value="${option.key}" 
                           ${isDefaultSelected ? 'checked' : ''}
                           onchange="handleOptionSelection(this)">
                    <div class="option-content">
                        <div class="option-label">${option.display_name}</div>
                        <div class="option-type">${option.category}</div>
                    </div>
                    <div class="option-count">${option.count.toLocaleString()}</div>
                `;
                
                optionItem.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = optionItem.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        handleOptionSelection(checkbox);
                    }
                });
                
                optionsGrid.appendChild(optionItem);
            });
            
            updateSelectionSummary();
        }

        function handleOptionSelection(checkbox) {
            const optionItem = checkbox.closest('.option-item');
            if (checkbox.checked) {
                optionItem.classList.add('selected');
            } else {
                optionItem.classList.remove('selected');
            }
            
            updateSelectionSummary();
            updatePathDefinitionOptions();
        }

        function updateSelectionSummary() {
            const selectedOptions = getSelectedOptions();
            const summary = document.getElementById('selectionSummary');
            
            if (selectedOptions.length === 0) {
                summary.textContent = 'ğŸ’¡ æš‚æ— é€‰ä¸­é¡¹ï¼Œè¯·é€‰æ‹©è¦åˆ†æçš„äº‹ä»¶ã€é¡µé¢ã€URLã€æ ‡é¢˜æˆ–æ¥æº';
                summary.style.background = '#fff3cd';
                summary.style.borderColor = '#ffeaa7';
                summary.style.color = '#856404';
            } else {
                const eventCount = selectedOptions.filter(opt => opt.startsWith('event_')).length;
                const pageCount = selectedOptions.filter(opt => opt.startsWith('page_')).length;
                const urlCount = selectedOptions.filter(opt => opt.startsWith('url_')).length;
                const titleCount = selectedOptions.filter(opt => opt.startsWith('title_')).length;
                const referrerCount = selectedOptions.filter(opt => opt.startsWith('referrer_')).length;
                
                const parts = [];
                if (eventCount > 0) parts.push(`äº‹ä»¶ ${eventCount} ä¸ª`);
                if (pageCount > 0) parts.push(`é¡µé¢ ${pageCount} ä¸ª`);
                if (urlCount > 0) parts.push(`URL ${urlCount} ä¸ª`);
                if (titleCount > 0) parts.push(`æ ‡é¢˜ ${titleCount} ä¸ª`);
                if (referrerCount > 0) parts.push(`æ¥æº ${referrerCount} ä¸ª`);
                
                summary.innerHTML = `âœ… å·²é€‰ä¸­ ${selectedOptions.length} ä¸ªé€‰é¡¹: ${parts.join(', ')}`;
                summary.style.background = '#e8f5e8';
                summary.style.borderColor = '#c3e6c3';
                summary.style.color = '#2e7d2e';
            }
        }

        function getSelectedOptions() {
            const checkboxes = document.querySelectorAll('#optionsGrid input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function updatePathDefinitionOptions() {
            const selectedOptions = getSelectedOptions();
            const startSelect = document.getElementById('startOptionSelect');
            const endSelect = document.getElementById('endOptionSelect');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            startSelect.innerHTML = '<option value="">ä»»æ„é€‰é¡¹</option>';
            endSelect.innerHTML = '<option value="">ä»»æ„é€‰é¡¹</option>';
            
            // æ·»åŠ é€‰ä¸­çš„é€‰é¡¹
            selectedOptions.forEach(optionKey => {
                const option = findOptionByKey(optionKey);
                if (option) {
                    const displayName = option.display_name;
                    
                    const option1 = document.createElement('option');
                    option1.value = optionKey;
                    option1.textContent = displayName;
                    startSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = optionKey;
                    option2.textContent = displayName;
                    endSelect.appendChild(option2);
                }
            });
        }

        function findOptionByKey(key) {
            return allAnalysisOptions.all.find(option => option.key === key);
        }

        function handlePathTypeChange() {
            const pathType = document.querySelector('input[name="pathType"]:checked').value;
            const startOption = document.getElementById('startOption');
            const endOption = document.getElementById('endOption');
            const startSelect = document.getElementById('startOptionSelect');
            const endSelect = document.getElementById('endOptionSelect');
            
            if (pathType === 'start') {
                startOption.classList.add('active');
                endOption.classList.remove('active');
                startSelect.disabled = false;
                endSelect.disabled = true;
                endSelect.value = '';
            } else {
                startOption.classList.remove('active');
                endOption.classList.add('active');
                startSelect.disabled = true;
                endSelect.disabled = false;
                startSelect.value = '';
            }
        }

        function getAnalysisParams() {
            const selectedOptions = getSelectedOptions();
            const pathType = document.querySelector('input[name="pathType"]:checked').value;
            
            return {
                selectedOptions: selectedOptions,
                pathType: pathType,
                startOption: pathType === 'start' ? document.getElementById('startOptionSelect').value : '',
                endOption: pathType === 'end' ? document.getElementById('endOptionSelect').value : '',
                pathLength: document.getElementById('pathLength').value,
                minConversions: parseInt(document.getElementById('minConversions').value) || 5,
                timeRange: document.getElementById('timeRange').value,
                pageFilter: document.getElementById('pageFilter').value.trim()
            };
        }

        function showLoading() {
            const loadingOption = {
                title: {
                    text: 'æ­£åœ¨åˆ†æè·¯å¾„æ•°æ®...',
                    left: 'center',
                    top: 'center',
                    textStyle: { color: '#667eea', fontSize: 16 }
                }
            };
            
            pathFlowChart.clear();
            pathFlowChart.setOption(loadingOption);
            stepDistributionChart.clear();
            stepDistributionChart.setOption(loadingOption);
            pathConversionChart.clear();
            pathConversionChart.setOption(loadingOption);
            
            // ç¦ç”¨åˆ†ææŒ‰é’®
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ğŸ”„ åˆ†æä¸­...';
        }

        function hideLoading() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'ğŸ” å¼€å§‹åˆ†æ';
        }

        async function analyzeUserPath() {
            if (isLoading) return;
            
            const params = getAnalysisParams();
            
            // éªŒè¯å‚æ•°
            if (params.selectedOptions.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåˆ†æé€‰é¡¹');
                return;
            }
            
            isLoading = true;
            showLoading();

            try {
                console.log('å¼€å§‹ç”¨æˆ·è·¯å¾„åˆ†æ:', params);
                
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const queryParams = new URLSearchParams();
                queryParams.append('selectedOptions', params.selectedOptions.join(','));
                queryParams.append('pathType', params.pathType);
                queryParams.append('startOption', params.startOption);
                queryParams.append('endOption', params.endOption);
                queryParams.append('pathLength', params.pathLength);
                queryParams.append('minConversions', params.minConversions);
                queryParams.append('timeRange', params.timeRange);
                queryParams.append('pageFilter', params.pageFilter);
                
                const response = await fetch(`/api/user-path-analysis?${queryParams}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                renderPathFlowChart(data.sankey || {});
                renderStepDistributionChart(data.stepDistribution || {});
                renderPathConversionChart(data.pathConversion || {});
                updatePathTable(data.pathStats || {});
                
                console.log('ç”¨æˆ·è·¯å¾„åˆ†æå®Œæˆ');
            } catch (error) {
                console.error('ç”¨æˆ·è·¯å¾„åˆ†æå¤±è´¥:', error);
                // ä½¿ç”¨ç¤ºä¾‹æ•°æ®
                loadMockPathData();
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        function renderPathFlowChart(sankeyData) {
            if (!sankeyData || !sankeyData.nodes || !sankeyData.links || 
                sankeyData.nodes.length === 0 || sankeyData.links.length === 0) {
                pathFlowChart.setOption({
                    title: {
                        text: 'æš‚æ— è·¯å¾„æµè½¬æ•°æ®',
                        subtext: 'è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶åé‡æ–°åˆ†æ',
                        left: 'center',
                        top: 'center',
                        textStyle: { color: '#999', fontSize: 16 }
                    }
                });
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.dataType === 'edge') {
                            return `${params.data.sourceName || 'èµ·ç‚¹'} â†’ ${params.data.targetName || 'ç»ˆç‚¹'}<br/>
                                   ç”¨æˆ·æ•°: ${params.data.value}<br/>
                                   è½¬æ¢ç‡: ${((params.data.value / (params.data.sourceTotal || params.data.value)) * 100).toFixed(1)}%`;
                        }
                        return `${params.name}<br/>è®¿é—®ç”¨æˆ·: ${params.value || 0}`;
                    }
                },
                series: [{
                    type: 'sankey',
                    data: sankeyData.nodes,
                    links: sankeyData.links,
                    emphasis: { focus: 'adjacency' },
                    lineStyle: {
                        color: 'gradient',
                        curveness: 0.5,
                        opacity: 0.6
                    },
                    label: {
                        fontSize: 11,
                        fontWeight: 'bold',
                        color: '#333'
                    },
                    itemStyle: {
                        borderWidth: 1,
                        borderColor: '#fff'
                    },
                    left: '3%',
                    right: '20%',
                    top: '5%',
                    bottom: '5%'
                }]
            };
            
            pathFlowChart.clear();
            pathFlowChart.setOption(option);
        }

        function renderStepDistributionChart(data) {
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} æ¡è·¯å¾„ ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    textStyle: { fontSize: 11 }
                },
                series: [{
                    name: 'è·¯å¾„æ­¥éª¤åˆ†å¸ƒ',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: data.steps || [
                        { value: 35, name: '2-3æ­¥è·¯å¾„' },
                        { value: 30, name: '4-5æ­¥è·¯å¾„' },
                        { value: 25, name: '6-8æ­¥è·¯å¾„' },
                        { value: 10, name: '9æ­¥ä»¥ä¸Š' }
                    ],
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        fontSize: 11
                    }
                }]
            };
            
            stepDistributionChart.clear();
            stepDistributionChart.setOption(option);
        }

        function renderPathConversionChart(data) {
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `${params.name}<br/>
                               ç”¨æˆ·æ•°: ${params.value}<br/>
                               è½¬åŒ–ç‡: ${((params.value / (data.totalUsers || params.value)) * 100).toFixed(1)}%`;
                    }
                },
                series: [{
                    name: 'è·¯å¾„è½¬åŒ–æ¼æ–—',
                    type: 'funnel',
                    left: '10%',
                    right: '10%',
                    top: '5%',
                    bottom: '5%',
                    data: data.funnelData || [
                        { value: 1000, name: 'è¿›å…¥åº”ç”¨' },
                        { value: 800, name: 'æµè§ˆé¡µé¢' },
                        { value: 600, name: 'äº§ç”Ÿäº¤äº’' },
                        { value: 300, name: 'æ·±åº¦ä½¿ç”¨' },
                        { value: 100, name: 'å®Œæˆç›®æ ‡' }
                    ],
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    label: {
                        show: true,
                        fontSize: 12,
                        position: 'inside'
                    },
                    labelLine: {
                        length: 10,
                        lineStyle: {
                            width: 1,
                            type: 'solid'
                        }
                    }
                }]
            };
            
            pathConversionChart.clear();
            pathConversionChart.setOption(option);
        }

        function updatePathTable(pathStats) {
            const tbody = document.getElementById('pathTableBody');
            tbody.innerHTML = '';
            
            if (!pathStats || Object.keys(pathStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">æš‚æ— è·¯å¾„æ•°æ®<br><small>è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶åé‡æ–°åˆ†æ</small></td></tr>';
                return;
            }

            const sortedPaths = Object.entries(pathStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 50);
            
            const totalPaths = sortedPaths.reduce((sum, [_, stats]) => sum + stats.count, 0);
            
            sortedPaths.forEach(([path, stats]) => {
                const row = document.createElement('tr');
                const percentage = ((stats.count / totalPaths) * 100).toFixed(1);
                
                row.innerHTML = `
                    <td title="${path}" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${path.length > 60 ? path.substring(0, 60) + '...' : path}
                    </td>
                    <td><strong>${stats.count}</strong></td>
                    <td>${percentage}%</td>
                    <td>${stats.avgDuration || '0s'}</td>
                    <td>${stats.conversionRate || '0%'}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; margin: 0; font-size: 12px;" 
                                onclick="analyzeSpecificPath('${path.replace(/'/g, '\\\'')}')" 
                                title="æ·±åº¦åˆ†ææ­¤è·¯å¾„">
                            è¯¦ç»†åˆ†æ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadMockPathData() {
            // ç¤ºä¾‹æ•°æ®
            const mockData = {
                sankey: {
                    nodes: [
                        { name: 'å¯åŠ¨åº”ç”¨' },
                        { name: 'é¦–é¡µæµè§ˆ' },
                        { name: 'å•†å“æœç´¢' },
                        { name: 'å•†å“è¯¦æƒ…' },
                        { name: 'æ·»åŠ è´­ç‰©è½¦' },
                        { name: 'æäº¤è®¢å•' }
                    ],
                    links: [
                        { source: 0, target: 1, value: 1000, sourceName: 'å¯åŠ¨åº”ç”¨', targetName: 'é¦–é¡µæµè§ˆ' },
                        { source: 1, target: 2, value: 600, sourceName: 'é¦–é¡µæµè§ˆ', targetName: 'å•†å“æœç´¢' },
                        { source: 1, target: 3, value: 300, sourceName: 'é¦–é¡µæµè§ˆ', targetName: 'å•†å“è¯¦æƒ…' },
                        { source: 2, target: 3, value: 400, sourceName: 'å•†å“æœç´¢', targetName: 'å•†å“è¯¦æƒ…' },
                        { source: 3, target: 4, value: 200, sourceName: 'å•†å“è¯¦æƒ…', targetName: 'æ·»åŠ è´­ç‰©è½¦' },
                        { source: 4, target: 5, value: 80, sourceName: 'æ·»åŠ è´­ç‰©è½¦', targetName: 'æäº¤è®¢å•' }
                    ]
                },
                stepDistribution: {
                    steps: [
                        { value: 35, name: '2-3æ­¥è·¯å¾„' },
                        { value: 30, name: '4-5æ­¥è·¯å¾„' },
                        { value: 25, name: '6-8æ­¥è·¯å¾„' },
                        { value: 10, name: '9æ­¥ä»¥ä¸Š' }
                    ]
                },
                pathConversion: {
                    totalUsers: 1000,
                    funnelData: [
                        { value: 1000, name: 'å¯åŠ¨åº”ç”¨' },
                        { value: 850, name: 'æµè§ˆé¦–é¡µ' },
                        { value: 600, name: 'æœç´¢å•†å“' },
                        { value: 350, name: 'æŸ¥çœ‹è¯¦æƒ…' },
                        { value: 200, name: 'æ·»åŠ è´­ç‰©è½¦' },
                        { value: 80, name: 'æäº¤è®¢å•' }
                    ]
                },
                pathStats: {
                    'å¯åŠ¨åº”ç”¨ â†’ é¦–é¡µæµè§ˆ â†’ å•†å“æœç´¢': { count: 450, conversionRate: '75%', avgDuration: '85s' },
                    'å¯åŠ¨åº”ç”¨ â†’ é¦–é¡µæµè§ˆ â†’ å•†å“è¯¦æƒ…': { count: 280, conversionRate: '68%', avgDuration: '120s' },
                    'å•†å“æœç´¢ â†’ å•†å“è¯¦æƒ… â†’ æ·»åŠ è´­ç‰©è½¦': { count: 180, conversionRate: '45%', avgDuration: '150s' },
                    'å•†å“è¯¦æƒ… â†’ æ·»åŠ è´­ç‰©è½¦ â†’ æäº¤è®¢å•': { count: 75, conversionRate: '38%', avgDuration: '200s' }
                }
            };
            
            renderPathFlowChart(mockData.sankey);
            renderStepDistributionChart(mockData.stepDistribution);
            renderPathConversionChart(mockData.pathConversion);
            updatePathTable(mockData.pathStats);
        }

        function resetFilters() {
            // é‡ç½®é€‰é¡¹é€‰æ‹©ï¼ˆä¿æŒæ ¸å¿ƒäº‹ä»¶é€‰ä¸­ï¼‰
            document.querySelectorAll('#optionsGrid input[type="checkbox"]').forEach(cb => {
                const isCore = cb.value.includes('$MPLaunch') || 
                              cb.value.includes('$MPShow') || 
                              cb.value.includes('$MPViewScreen');
                cb.checked = isCore;
                const optionItem = cb.closest('.option-item');
                if (isCore) {
                    optionItem.classList.add('selected');
                } else {
                    optionItem.classList.remove('selected');
                }
            });
            
            // é‡ç½®è·¯å¾„å®šä¹‰
            document.querySelector('input[name="pathType"][value="start"]').checked = true;
            handlePathTypeChange();
            document.getElementById('startOptionSelect').value = '';
            document.getElementById('endOptionSelect').value = '';
            
            // é‡ç½®å…¶ä»–æ¡ä»¶
            document.getElementById('pathLength').value = 'all';
            document.getElementById('minConversions').value = '5';
            document.getElementById('timeRange').value = 'last7days';
            document.getElementById('pageFilter').value = '';
            
            updateSelectionSummary();
            updatePathDefinitionOptions();
        }

        function analyzeSpecificPath(path) {
            alert(`è¯¦ç»†åˆ†æè·¯å¾„: ${path}\n\næ­¤åŠŸèƒ½å°†æ˜¾ç¤ºè¯¥è·¯å¾„çš„ï¼š\n- ç”¨æˆ·åˆ†å¸ƒç‰¹å¾\n- æ¯æ­¥åœç•™æ—¶é—´\n- æµå¤±åŸå› åˆ†æ\n- ä¼˜åŒ–å»ºè®®`);
        }

        function goBack() {
            window.history.back();
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç”¨æˆ·è·¯å¾„åˆ†æé¡µé¢åŠ è½½å®Œæˆ');
            initCharts();
            loadAnalysisOptions();
            
            // å»¶è¿ŸåŠ è½½åˆå§‹æ•°æ®
            setTimeout(() => {
                if (getSelectedOptions().length > 0) {
                    analyzeUserPath();
                }
            }, 2000);
        });
    </script>
</body>
</html>